<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Using SLURM â€¢ Zorn</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Using SLURM">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">Zorn</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../articles/install.html">Install</a></li>
<li class="nav-item"><a class="nav-link" href="../articles/get_started.html">Get started</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-vignettes" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Vignettes</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-vignettes">
<li><h6 class="dropdown-header" data-toc-skip>Introductory Vignettes</h6></li>
    <li><a class="dropdown-item" href="../articles/slurm.html">Using SLURM</a></li>
    <li><a class="dropdown-item" href="../articles/debarcoding.html">Debarcoding</a></li>
    <li><a class="dropdown-item" href="../articles/read_quality_control.html">Read-based quality control</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><a class="dropdown-item" href="../articles/kraken.html">KRAKEN-based workflow</a></li>
    <li><a class="dropdown-item" href="../articles/alignment.html">Alignment-based workflow</a></li>
    <li><a class="dropdown-item" href="../articles/kmer.html">Informative KMER-based workflow</a></li>
    <li><a class="dropdown-item" href="../articles/countsketch.html">Count sketch KMER-based workflow</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><a class="dropdown-item" href="../articles/clustering.html">Clustering</a></li>
    <li><a class="dropdown-item" href="../articles/assembly.html">De novo assembly</a></li>
    <li><a class="dropdown-item" href="../articles/genome_annotation.html">Genome annotation</a></li>
    <li><a class="dropdown-item" href="../articles/snp_analysis.html">SNP analysis</a></li>
    <li><a class="dropdown-item" href="../articles/map_scripts.html">Map scripts</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><a class="dropdown-item" href="../articles/fileformats.html">Overview of file formats</a></li>
    <li><a class="dropdown-item" href="../articles/bascet_files.html">Working with Bascet files</a></li>
    <li><a class="dropdown-item" href="../articles/for_developers.html">For developers</a></li>
    <li><a class="dropdown-item" href="../articles/example_data.html">Example data</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../articles/faq.html">FAQ</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><a class="external-link nav-link" href="https://henlab.org/" aria-label="Lab website"><span class="fa fa-home"></span></a></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/henriksson-lab/zorn" aria-label="GitHub repository"><span class="fa fa-github"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Using SLURM</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/henriksson-lab/zorn/blob/main/vignettes/slurm.Rmd" class="external-link"><code>vignettes/slurm.Rmd</code></a></small>
      <div class="d-none name"><code>slurm.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>Zorn is designed to be a full replacement for the NextFlow job
manager, for the processing of single-cell genomics and microbial
isolates. This design is motivated by the Bascet file format: While
NextFlow operates on a file-by-file basis, Bascet keeps cells together
in sharded objects. These are natural minibatches of otherwise rather
small tasks, reducing the overhead of scheduling work for the (possibly
many!) cells.</p>
<p><a href="https://slurm.schedmd.com" class="external-link">SLURM</a> is one of the most
common job managers out there, and Zorn thus works on top of SLURM by
writing out the appropriate Bascet commands. If you do not have SLURM on
your cluster, we are interested to hear what else people are using!</p>
</div>
<div class="section level2">
<h2 id="usage">Usage<a class="anchor" aria-label="anchor" href="#usage"></a>
</h2>
<p>To use SLURM, you have to get used to slightly different semantics
than if you run locally. First you need to set up a runner. The way we
recommend you to do it, these are only default values, such as which
partition to submit to, and the name of your account. You can also set a
permissible default timeout time:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## Set the new default runner. Note that the name should not be changed!</span></span>
<span><span class="va">bascet_runner.default</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/SlurmRunner.html">SlurmRunner</a></span><span class="op">(</span></span>
<span>  partition<span class="op">=</span><span class="st">"shared"</span>, </span>
<span>  account<span class="op">=</span><span class="st">"name_of_your_project"</span>, </span>
<span>  time<span class="op">=</span><span class="st">"0-24:00:00"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co">## get a Bascet instance as usual; this is a separate concern from the runner</span></span>
<span><span class="va">bascet_instance.default</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/getBascetSingularityImage.html">getBascetSingularityImage</a></span><span class="op">(</span>store_at<span class="op">=</span><span class="st">"~/"</span><span class="op">)</span></span></code></pre></div>
<p>You then make calls to Bascet as in all other tutorials. The main
script, in charge of the control flow, should be run in <a href="https://github.com/tmux/tmux/wiki" class="external-link">tmux</a> or <a href="https://linuxize.com/post/how-to-use-linux-screen/" class="external-link">screen</a>, on
a login node of your cluster.</p>
<p>You likely want to tune each SLURM job a bit in terms of how many
cores are used. This is the suggested method, where only relevant
settings are overridden on a per-job basis:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">BascetGetRawAtrandiWGS</span><span class="op">(</span></span>
<span>  <span class="va">bascetRoot</span>,</span>
<span>  <span class="va">rawmeta</span>,</span>
<span>  runner<span class="op">=</span><span class="fu"><a href="../reference/SlurmRunner.html">SlurmRunner</a></span><span class="op">(</span></span>
<span>    <span class="va">bascet_runner.default</span>,</span>
<span>    ncpu<span class="op">=</span><span class="fl">5</span>,</span>
<span>    mem<span class="op">=</span><span class="st">"5g"</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="slurm-settings">SLURM settings<a class="anchor" aria-label="anchor" href="#slurm-settings"></a>
</h2>
<p>We are unable to give specific suggestions on cpu and memory as it
depends on how your SLURM instance is configured. As an example, Swedish
clusters are set up to give memory in proportion to the number of
CPUs.</p>
<p>Bascet is written to avoid using large amounts of RAM when possible.
Exceptions are the use of downstream software such as KRAKEN (in
particular).</p>
<p>All operations are multithreaded and benefit from having more CPUs
per node. Speed is however limited by disk access speed. It it thus
worth investigating your log files after execution to see how much
CPU/memory you actually needed, to improve long-term running of
Bascet.</p>
</div>
<div class="section level2">
<h2 id="advanced-asynchronous-execution">Advanced: Asynchronous execution<a class="anchor" aria-label="anchor" href="#advanced-asynchronous-execution"></a>
</h2>
<p>You can also set up SLURM jobs to run in the background, instead of
stalling your R session until done. This can primarily be useful if you
want to use the same R session for doing other work while waiting for
the job.</p>
<p>To set up this mode of running, you create the SLURM runner slightly
differently:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" tabindex="-1"></a><span class="do">## Set the new default runner. Note that the name should not be changed!</span></span>
<span id="cb3-2"><a href="#cb3-2" tabindex="-1"></a>bascet_runner.default <span class="ot">&lt;-</span> <span class="fu">SlurmRunner</span>(</span>
<span id="cb3-3"><a href="#cb3-3" tabindex="-1"></a>  ... <span class="co">#previous settings</span></span>
<span id="cb3-4"><a href="#cb3-4" tabindex="-1"></a>  <span class="at">direct=</span><span class="cn">FALSE</span> <span class="do">## new! asynchronous mode</span></span>
<span id="cb3-5"><a href="#cb3-5" tabindex="-1"></a>)</span>
<span id="cb3-6"><a href="#cb3-6" tabindex="-1"></a></span>
<span id="cb3-7"><a href="#cb3-7" tabindex="-1"></a><span class="do">## get a Bascet instance as usual; this is a separate concern from the runner</span></span>
<span id="cb3-8"><a href="#cb3-8" tabindex="-1"></a>bascet_instance.default <span class="ot">&lt;-</span> <span class="fu">getBascetSingularityImage</span>(<span class="at">store_at=</span><span class="st">"~/"</span>)</span></code></pre></div>
<p>Whenever you run a job, you now want to catch a handle to the job in
a variable:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">my_job</span> <span class="op">&lt;-</span> <span class="fu">BascetGetRawAtrandiWGS</span><span class="op">(</span>  <span class="co">#note, store job in a variable</span></span>
<span>  <span class="va">bascetRoot</span>,</span>
<span>  <span class="va">rawmeta</span>,</span>
<span>  runner<span class="op">=</span><span class="fu"><a href="../reference/SlurmRunner.html">SlurmRunner</a></span><span class="op">(</span></span>
<span>    <span class="va">bascet_runner.default</span>,</span>
<span>    ncpu<span class="op">=</span><span class="fl">5</span>,</span>
<span>    mem<span class="op">=</span><span class="st">"5g"</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>After running this command, you will immediately get the control
back. To see the status of a job, it is best to just run WaitForJob:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">WaitForJob</span><span class="op">(</span><span class="va">my_job</span><span class="op">)</span></span></code></pre></div>
<p>You can press ctrl+c to end the waiting loop early</p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Johan Henriksson, Laura Carroll, Hadrien GourlÃ©, Julian Dicken, Henriksson Lab, Carroll Lab and Collaborators.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer>
</div>





  </body>
</html>
