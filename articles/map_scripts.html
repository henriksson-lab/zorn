<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Map scripts • Zorn</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Map scripts">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">Zorn</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../articles/install.html">Install</a></li>
<li class="nav-item"><a class="nav-link" href="../articles/get_started.html">Get started</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-vignettes" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Vignettes</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-vignettes">
<li><h6 class="dropdown-header" data-toc-skip>Introductory Vignettes</h6></li>
    <li><a class="dropdown-item" href="../articles/slurm.html">Using SLURM</a></li>
    <li><a class="dropdown-item" href="../articles/debarcoding.html">Debarcoding</a></li>
    <li><a class="dropdown-item" href="../articles/read_quality_control.html">Read-based quality control</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><a class="dropdown-item" href="../articles/kraken.html">KRAKEN-based workflow</a></li>
    <li><a class="dropdown-item" href="../articles/alignment.html">Alignment-based workflow</a></li>
    <li><a class="dropdown-item" href="../articles/kmer.html">Informative KMER-based workflow</a></li>
    <li><a class="dropdown-item" href="../articles/countsketch.html">Count sketch KMER-based workflow</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><a class="dropdown-item" href="../articles/clustering.html">Clustering</a></li>
    <li><a class="dropdown-item" href="../articles/assembly.html">De novo assembly</a></li>
    <li><a class="dropdown-item" href="../articles/genome_annotation.html">Genome annotation</a></li>
    <li><a class="dropdown-item" href="../articles/map_scripts.html">Map scripts</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><a class="dropdown-item" href="../articles/fileformats.html">Overview of file formats</a></li>
    <li><a class="dropdown-item" href="../articles/for_developers.html">For developers</a></li>
    <li><a class="dropdown-item" href="../articles/example_data.html">Example data</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../articles/faq.html">FAQ</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><a class="external-link nav-link" href="https://henlab.org/" aria-label="Lab website"><span class="fa fa-home"></span></a></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/henriksson-lab/zorn" aria-label="GitHub repository"><span class="fa fa-github"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Map scripts</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/henriksson-lab/zorn/blob/main/vignettes/map_scripts.Rmd" class="external-link"><code>vignettes/map_scripts.Rmd</code></a></small>
      <div class="d-none name"><code>map_scripts.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="running-a-map-function">Running a MAP function<a class="anchor" aria-label="anchor" href="#running-a-map-function"></a>
</h2>
<p>Zorn/Bascet is designed to let you run all kinds of software that
operates on your cells. This can be either the raw reads, the contigs,
or any other data that you produce. Because these operations can be
computationally intense, all of this happens through the MAP
framework.</p>
<p>Here is an example of invoking the built-in QUAST script to produce
quality metrics of each assembled genome:</p>
<p><a href="slurm.html">(SLURM-compatible step)</a></p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/BascetMapCell.html">BascetMapCell</a></span><span class="op">(</span></span>
<span>  <span class="va">bascetRoot</span>,</span>
<span>  withfunction <span class="op">=</span> <span class="st">"_quast"</span>,</span>
<span>  inputName <span class="op">=</span> <span class="st">"skesa"</span>,</span>
<span>  outputName <span class="op">=</span> <span class="st">"quast"</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="aggregating-map-results">Aggregating MAP results<a class="anchor" aria-label="anchor" href="#aggregating-map-results"></a>
</h2>
<p>Once you have run your map function, you most likely want to load the
results into R. We call this procedure “aggregate”. In case of QUAST,
this procedure loads all quality metrics into an R data.frame
object:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">quast_aggr</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/MapListAsDataFrame.html">MapListAsDataFrame</a></span><span class="op">(</span><span class="fu"><a href="../reference/BascetAggregateMap.html">BascetAggregateMap</a></span><span class="op">(</span></span>
<span>  <span class="va">bascetRoot</span>,</span>
<span>  inputName<span class="op">=</span><span class="st">"quast"</span>,</span>
<span>  <span class="va">aggr.quast</span></span>
<span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="arguments-to-map-functions">Arguments to MAP functions<a class="anchor" aria-label="anchor" href="#arguments-to-map-functions"></a>
</h2>
<p>Some scripts require additional arguments to be sent (such as a link
to a database file). This is done by setting the args argument. Below
will set two environment variables such that the contents can be picked
up the script:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" tabindex="-1"></a><span class="fu">BascetMapCell</span>(</span>
<span id="cb3-2"><a href="#cb3-2" tabindex="-1"></a>  ...</span>
<span id="cb3-3"><a href="#cb3-3" tabindex="-1"></a>  <span class="fu">args</span>(<span class="at">DB=</span><span class="st">"some/path"</span>,<span class="at">OTHERARG=</span><span class="st">"hi"</span>)</span>
<span id="cb3-4"><a href="#cb3-4" tabindex="-1"></a>  ...</span>
<span id="cb3-5"><a href="#cb3-5" tabindex="-1"></a>)</span></code></pre></div>
</div>
<div class="section level2">
<h2 id="custom-map-functions---introduction">Custom MAP functions - introduction<a class="anchor" aria-label="anchor" href="#custom-map-functions---introduction"></a>
</h2>
<p>It is easy to add new functions! Easiest way is to simply copy and
modify the code for an existing script. You can start from either * <a href="https://github.com/henriksson-lab/bascet/blob/main/src/mapcell_scripts/quast.sh" class="external-link">QUAST</a>,
which takes contigs as input * <a href="https://github.com/henriksson-lab/bascet/blob/main/src/mapcell_scripts/skesa.sh" class="external-link">SKESA</a>,
which takes FASTQ as input</p>
<p>Once you have written your script, you invoke it with a direct
path:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/BascetMapCell.html">BascetMapCell</a></span><span class="op">(</span></span>
<span>  <span class="va">bascetRoot</span>,</span>
<span>  withfunction <span class="op">=</span> <span class="st">"/path/to/your/script.sh"</span>,</span>
<span>  inputName <span class="op">=</span> <span class="st">"..."</span>,</span>
<span>  outputName <span class="op">=</span> <span class="st">"..."</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>In most cases you want to write your own aggregate function. This
function will take the output from your tool, parse it, and put in a
sensible R object. Have a look at <a href="https://github.com/henriksson-lab/zorn/blob/main/R/aggr_functions.R" class="external-link">example
and existing aggregate functions</a> for inspiration.</p>
<p>There is also a catch-all aggregate function that requires a bit of a
special way of calling. The example below takes “out.txt”, generated by
each tool, and stores the raw file content in a list. This is not pretty
but it may help you in debugging and development:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">quast_aggr</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/MapListAsDataFrame.html">MapListAsDataFrame</a></span><span class="op">(</span><span class="fu"><a href="../reference/BascetAggregateMap.html">BascetAggregateMap</a></span><span class="op">(</span></span>
<span>  <span class="va">bascetRoot</span>,</span>
<span>  inputName<span class="op">=</span><span class="st">".."</span>,</span>
<span>  <span class="fu">aggr.raw</span><span class="op">(</span><span class="st">"out.txt"</span><span class="op">)</span></span>
<span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="custom-map-functions---details">Custom MAP functions - details<a class="anchor" aria-label="anchor" href="#custom-map-functions---details"></a>
</h2>
<p>If you look at any <a href="https://github.com/henriksson-lab/bascet/blob/main/src/mapcell_scripts/quast.sh" class="external-link">example
MAP function</a>, you will find that it is a BASH script that conforms
to a certain pattern. It actually is just a script (in any language)
that takes certain command line arguments.</p>
<pre class="console"><code><span><span class="op">-</span><span class="op">-</span><span class="va">bascet</span><span class="op">-</span><span class="va">api</span></span></code></pre>
<p>The script returns the API version, also validating that it is a
valid script for MAP calls</p>
<pre class="console"><code><span><span class="op">-</span><span class="op">-</span><span class="va">expect</span><span class="op">-</span><span class="va">files</span></span></code></pre>
<p>The script returns a list of what files to extract from the Bascet,
for each cell. Here, “*” means to get everything. Asking for less means
higher performance</p>
<pre class="console"><code></code></pre>
<p>–missing-file-mode The Bascet what to do if the files are missing.
“skip” means to just proceed with the next cell</p>
<pre class="console"><code><span><span class="op">-</span><span class="op">-</span><span class="va">compression</span><span class="op">-</span><span class="va">mode</span></span></code></pre>
<p>How to compress the output files. “default” means to compress.
However, if your tool generates compressed files already, it is just a
waste of time trying to do it again, in which case the script can return
“uncompressed”.</p>
<pre class="console"><code>--input-dir XXX</code></pre>
<p>This is the directory where input files are located</p>
<pre class="console"><code>--output-dir YYY</code></pre>
<p>Where to store output to. This directory is already created</p>
<pre class="console"><code>--num-threads ZZZ</code></pre>
<p>How many threads to use for this particular process. Note that Bascet
is already calling multiple MAP scripts in parallel and there is thus
typically little benefit in making individual process multithreaded</p>
<pre class="console"><code><span><span class="op">-</span><span class="op">-</span><span class="va">recommend</span><span class="op">-</span><span class="va">threads</span></span></code></pre>
<p>Return how many threads (at least 1) the job should get. This is used
if the user runs mapcell but only specifies the total number of threads.
Bascet will then try to allocate workers accordingly. Return 1 if your
mapcell script does not support multithreading</p>
<pre class="console"><code><span><span class="op">-</span><span class="op">-</span><span class="va">preflight</span><span class="op">-</span><span class="va">check</span></span></code></pre>
<p>This is called once only, to check that the script has the needed
software dependencies. In such case, it returns “MAPCELL-CHECK”</p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Johan Henriksson, Laura Carroll, Hadrien Gourlé, Julian Dicken, Henriksson Lab, Carroll Lab and Collaborators.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
